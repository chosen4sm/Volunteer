rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.admin == true;
    }
    
    // Helper function to check if user is viewer (read-only admin)
    function isViewer() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.viewer == true;
    }
    
    // Helper function to check if user has admin or viewer access
    function hasAccess() {
      return isAdmin() || isViewer();
    }
    
    // Form configuration (public read, admin write only)
    match /form-config/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // User profiles
    match /profiles/{userId} {
      // Users can read their own profile, or admins/viewers can read all profiles
      allow read: if (request.auth != null && request.auth.uid == userId) || hasAccess();
      
      // Users can create their own profile (with admin: false and viewer: false only)
      // OR admins can create profiles for anyone
      allow create: if (request.auth != null && 
                        request.auth.uid == userId &&
                        request.resource.data.admin == false &&
                        request.resource.data.viewer == false) ||
                       isAdmin();
      
      // Only admins can update or delete profiles
      allow update, delete: if isAdmin();
    }
    
    // Public volunteer form submissions
    match /volunteers/{volunteerId} {
      // Anyone can create a volunteer submission if accepting submissions
      allow create: if (
        get(/databases/$(database)/documents/form-config/main).data.get('acceptingSubmissions', true) == true &&
        request.resource.data.keys().hasAll(['name', 'phone', 'email', 'submittedAt']) &&
        request.resource.data.name is string && request.resource.data.name.size() > 0 &&
        request.resource.data.phone is string && request.resource.data.phone.size() > 0 &&
        request.resource.data.email is string && request.resource.data.email.size() > 0 &&
        (request.resource.data.keys().hasAny(['shifts', 'availability'])) &&
        request.resource.data.submittedAt is timestamp
      );
      
      // Anyone can read volunteers (needed for volunteer portal and email existence check)
      allow read: if true;
      
      // Volunteers can update their own checkIns array through the portal
      // or anyone can update basic info (but can't change email)
      allow update: if (
        (request.resource.data.email == resource.data.email &&
         request.resource.data.name is string && request.resource.data.name.size() > 0 &&
         request.resource.data.phone is string && request.resource.data.phone.size() > 0) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['checkIns']))
      );
      
      // Only admins can delete volunteers
      allow delete: if isAdmin();
    }
    
    // Locations (categories)
    match /locations/{locationId} {
      // Anyone can read locations (needed for volunteer portal)
      allow read: if true;
      // Only admins can create, update, delete
      allow create, update, delete: if isAdmin();
    }
    
    // Tasks (sub-categories under locations)
    match /tasks/{taskId} {
      // Anyone can read tasks (needed for volunteer portal)
      allow read: if true;
      // Only admins can create, update, delete
      allow create, update, delete: if isAdmin();
    }
    
    // Assignments (manual volunteer-to-task assignments)
    match /assignments/{assignmentId} {
      // Anyone can read assignments (needed for volunteer portal)
      allow read: if true;
      // Only admins can create, delete
      allow create, delete: if isAdmin();
      // Admins can update all fields, or anyone can update status field only
      allow update: if isAdmin() || 
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);
    }
  }
}